<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carrefour l'atelier - Gestion du budget</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Firebase en mode compat -->
    <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        h1 { color: #007bff; }
        button { padding: 10px; margin: 5px; font-size: 16px; cursor: pointer; }
        select, input { padding: 10px; margin: 5px; font-size: 16px; }
        ul { list-style-type: none; padding: 0; }
    </style>
</head>
<body>
    <h1>Carrefour l'atelier - Gestion du budget</h1>

    <!-- SÃ©lection du budget -->
    <h2>Choisir la catÃ©gorie :</h2>
    <select id="budgetSelection" onchange="chargerBudget()">
        <option value="horsVacances">Hors vacances (800â‚¬)</option>
        <option value="adosHiver">Club Ados - Vacances d'hiver (250â‚¬)</option>
        <option value="enfantsHiver">Club Enfants - Vacances d'hiver (250â‚¬)</option>
        <option value="adosPrintemps">Club Ados - Vacances de printemps (250â‚¬)</option>
        <option value="enfantsPrintemps">Club Enfants - Vacances de printemps (250â‚¬)</option>
    </select>

    <h2>Budget restant : <span id="budget">Chargement...</span> â‚¬</h2>

    <input type="number" id="amount" placeholder="Montant Ã  dÃ©duire">
    <button onclick="deduireMontant()">DÃ©duire</button>

    <h3>Historique des dÃ©penses :</h3>
    <ul id="history"></ul>

    <script>
        // ðŸ”¥ CONFIGURATION FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBaNNWoRNUC7d7N-Lt16Gu-Sv1k...",
            authDomain: "carrefouratelier.firebaseapp.com",
            projectId: "carrefouratelier",
            storageBucket: "carrefouratelier.appspot.com",
            messagingSenderId: "400841694123",
            appId: "1:400841694123:web:244058132886b3..."
        };

        // ðŸ”¥ Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const docRef = db.collection("budgets").doc("global");

        // âœ… Budgets de base avec les bons montants
        const budgetsParDefaut = {
            horsVacances: 800,
            adosHiver: 250,
            enfantsHiver: 250,
            adosPrintemps: 250,
            enfantsPrintemps: 250,
            historique: {}
        };

        let budgets = { ...budgetsParDefaut };

        // âœ… Charger le budget depuis Firestore
        async function chargerBudget() {
            const selectedBudget = document.getElementById("budgetSelection").value;
            const doc = await docRef.get();
            
            if (doc.exists) {
                budgets = doc.data();
            } else {
                await docRef.set(budgetsParDefaut);
                budgets = { ...budgetsParDefaut };
            }

            document.getElementById("budget").textContent = budgets[selectedBudget];
            afficherHistorique(selectedBudget);
        }

        // âœ… DÃ©duire un montant
        async function deduireMontant() {
            const selectedBudget = document.getElementById("budgetSelection").value;
            let amount = parseFloat(document.getElementById("amount").value);
            if (isNaN(amount) || amount <= 0) return;

            budgets[selectedBudget] -= amount;
            if (!budgets.historique[selectedBudget]) {
                budgets.historique[selectedBudget] = [];
            }
            budgets.historique[selectedBudget].push(`- ${amount}â‚¬`);

            await docRef.set(budgets);
            document.getElementById("budget").textContent = budgets[selectedBudget];
            afficherHistorique(selectedBudget);
            document.getElementById("amount").value = "";
        }

        // âœ… Afficher l'historique des dÃ©penses
        function afficherHistorique(selectedBudget) {
            const list = document.getElementById("history");
            list.innerHTML = "";
            const historique = budgets.historique[selectedBudget] || [];
            
            historique.forEach((item, index) => {
                let li = document.createElement("li");
                li.innerHTML = `${item} <button onclick="annulerDepense('${selectedBudget}', ${index})">Annuler</button>`;
                list.appendChild(li);
            });
        }

        // âœ… Annuler une dÃ©pense avec confirmation
        async function annulerDepense(selectedBudget, index) {
            if (!confirm("ÃŠtes-vous sÃ»r de vouloir supprimer cette dÃ©pense ?")) return;

            let montantAnnule = parseFloat(budgets.historique[selectedBudget][index].replace("- ", "").replace("â‚¬", ""));
            budgets[selectedBudget] += montantAnnule;
            budgets.historique[selectedBudget].splice(index, 1);

            await docRef.set(budgets);
            document.getElementById("budget").textContent = budgets[selectedBudget];
            afficherHistorique(selectedBudget);
        }

        // Charger les donnÃ©es Firestore au dÃ©marrage
        chargerBudget();
    </script>
</body>
</html>
